---
title: 네트워크 장비 - 4계층 장비(로드 밸런서)
date: 2024-01-10
categories: ["NETWORK"]
tags: ['networking']     # TAG names should always be lowercase
toc: true
---

## 4계층 장비의 특징

4계층 장비는 TCP와 같은 4계층 헤더에 있는 정보를 이해하고 이 정보들을 기반으로 동작한다. 다른 계층 장비와 가장큰 다른점은 `세션 테이블`이라는 것을 이용해서 통신을 관리한다는 것이다.

## 로드 밸런서

서버나 장비의 부하를 분산하기 위해 사용하는 장비를 `로드 밸런서`라고 한다.
* L4 로드 밸런싱: 일반적인 로드 밸런서가 동작하는 방식이다. TCP/UDP 정보(특히 포트번호)를 기반으로 로드 밸런싱을 수행한다.
* L7 로드 밸런싱: HTTP, FTP, SMTP와 같은 애플리케이션 프로토콜 정보를 기반으로 로드 밸런싱을 수행한다.

### L4 스위치

L4 스위치는 용어 그대로 4계층에서 동작하면서 로드 밸런서 기능이 있는 스위치이다. 부하 분산, 성능 최적화, 리다이렉션 같은 기능을 제공한다. 해당 장비가 동작하기 위해서는 **가상 서버, 가상 IP, 리얼 서버, 리얼 IP**가 필요하다. L4 스위치는 가상 IP를 리얼 IP로 변환해주는 역할을 한다.
유저가 L4 스위치의 가상 IP를 목적지로 요청하면 L4 스위치는 목적지로 설정된 가상 IP를 리얼 IP로 다시 변경해서 보내준다.

이러한 부하 분산 뿐만 아니라 TCP 계층에서의 최적화와 보안 기능도 함께 제공할 수 있다. 

### ADC(L7 로드 밸런서)

ADC는 7계층(애플리케이션 계층)에서 동작하는 로드 밸런서이다. 7계층에서 동작함으로써 애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작한다.

## 방화벽

네트워크 중간에 위치해서 해당 장비를 통과하는 트래픽을 사전에 주어진 정책 조건에 맞추어 허용하거나 차단하는 장비를 `방화벽`이라고 부른다.
세션 정보를 장비 내부에 저장하고, 패킷이 나가거나 들어올때 저장했던 세션 정보를 먼저 참조해 들어오는 패킷이 외부에서 처음시작된 패킷인지 내부 사용자가 외부로 요청한 응답인지 가려낸다.

### 세션 관리

1. 3 way handshake를 통해 정상적으로 세션 설정 -> 방화벽에서 세션 설정 과정 확인 후 세션 테이블 기록
2. (세션이 유지되는 동안)세션 테이블을 참조해 방화벽에서 세션 통과
3. 일정 시간 동안 통신 없음
4. 세션 타임아웃으로 인한 세션 테이블 만료
5. 세션 만료 후 애플리케이션 통신 시작
6. 애플리케이션에서 SYN이 아닌 ACK가 패킷으로 보내고 방화벽에서 패킷 드롭

> 개발자 입장에서 세션이 안끊기게 하려면 주기적을 패킷을 발생해야한다.
{: .prompt-tip }

### 비대칭 경로 문제

일반적으로 네트워크의 안정성을 높이기 위해 네트워크 회선과 장비를 이중화한다. 이러면 패킷이 자니가는 경로가 두개 이상이므로 인바운드 패킷과 아웃바운드 패킷의 경로가 같거나 다르게 된다. 인바운드 패킷과 아웃바운드 패킷이 같은 장비를 통과하는 것을 `대칭 경로`라고 하고, 다른 장비를 통과하는 것을 `비대칭경로` 라고 한다. 

비대칭경로로 통신을 하게 되면 세션 테이블이 다르므로 정상적으로 통신이 되지 않는다. 이러한 문제를 해결하기 위하여 `세션 테이블을 동기`화 하는 방법이 있는데, 세션을 동기화하는 시간보다 패킷 응답이 빠르면 해당 방법은 무용지물이 된다. 두번쨰 방법은 비대칭 경로가 생길 경우에 세션 장비에서 인바운드패킷이 통과한 다른 세션 장비 쪽으로 보내서 `경로를 보정`하는것이다.

### 하나의 통신에 두 개 이상의 세션이 사용될 때

프로토콜은 `데이터 프로토콜`과 `컨트롤 프로토콜`로 구분할 수 있다. 데이터 프로토콜은 데이터를 실어 나르고, 컨트롤 프로토콜은 데이터가 잘 전송되도록 세션을 제어한다.

현대의 프로토콜은 하나의 통신을 위해 한 개의 세션만 사용하지만, 특별한 목적으로 두 개 이상의 세션을 만드는 경우가 있다. 이때 서로 다른 두 세션이 하나의 통신을 위해 사용하고 있다는 것을 네트워크 통신 중간에 놓인 세션 장비도 알아야한다. 